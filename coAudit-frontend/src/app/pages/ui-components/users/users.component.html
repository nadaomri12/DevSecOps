<mat-card class="cardWithShadow theme-card">
  <mat-card-header>
    <mat-card-title class="m-b-0">La liste des employés</mat-card-title>
  </mat-card-header>
  <mat-card-content class="b-t-1">
    <div class="filter">
      <mat-form-field class="filter-input">
        <mat-label>Filtrer</mat-label>
        <input matInput (keyup)="applyFilter($event)" placeholder="Ex. Titre" #input>
      </mat-form-field>
      <button mat-raised-button color="primary" class="button" (click)="openPopup()">
        <mat-icon>add</mat-icon>
        Ajouter
      </button>
      <button mat-raised-button color="warn" class="button" (click)="downloadData()">
        <mat-icon>download</mat-icon>
        Télécharger
      </button>
    </div>
    <div class="mat-elevation-z8 table-container">
      <div class="table-wrapper">
        <table mat-table [dataSource]="dataSource" matSort>
          
          <!-- Full Name Column -->
          <ng-container matColumnDef="fullName">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Nom </th>
            <td mat-cell *matCellDef="let row"> {{ row.fullName }} </td>
          </ng-container>
          
          <!-- Code Column -->
          <ng-container matColumnDef="code">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Code </th>
            <td mat-cell *matCellDef="let row"> {{ row.code }} </td>
          </ng-container>
          
          <!-- Email Column -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef mat-sort-header> Email </th>
            <td mat-cell *matCellDef="let row"> {{ row.email }} </td>
          </ng-container>
          
         
          
          
          <!-- Action Column -->
          <ng-container matColumnDef="action">
            <th mat-header-cell *matHeaderCellDef> Action </th>
            <td mat-cell *matCellDef="let row">
              <div class="action-buttons">
                <button mat-icon-button color="primary" (click)="openUserdetail(row)">
                  <mat-icon>visibility</mat-icon>
                </button>
                <button mat-icon-button color="accent" (click)="openUserDialog(row)">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button color="warn" (click)="confirmDelete($event, row.id)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>
    
          <!-- Table Rows -->
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          
          <!-- Row shown when there is no matching data. -->
          <tr class="mat-row" *matNoDataRow>
            <td class="mat-cell" colspan="6">Aucune donnée correspondante pour le filtre "{{input.value}}"</td>
          </tr>
        </table>
        
        <mat-paginator [length]="totalUsers"
          [pageSize]="pageSize"
          [pageIndex]="currentPage"
          [pageSizeOptions]="[5, 10, 25, 100]"
          (page)="onPageChange($event)"
          aria-label="Select page">
        </mat-paginator>
      </div>
    </div>
    
  </mat-card-content>
</mat-card>

<!-- Popup dialog for adding user -->
<div *ngIf="showPopup" class="popup">
  <div class="popup-content">
    <mat-dialog-content class="mat-mdc-dialog-content mdc-dialog__content ng-star-inserted" style="max-width: 600px;">
      <form novalidate [formGroup]="userForm">
        <h2 style="text-align: center; text-decoration: underline; ">  un nouveau utilisateur</h2>
        
        <div class="row">
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <input type="text" matInput required placeholder="Nom et prénom" formControlName="fullName">
              <div class="text-danger" *ngIf="userForm.controls['fullName'].invalid && (userForm.controls['fullName'].touched || isFormSubmitted || userForm.controls['fullName'].dirty)">
                <mat-error *ngIf="userForm.controls['fullName'].errors?.['required']">Ce champ est obligatoire</mat-error>
              </div>
              </mat-form-field>
           
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <input type="email" matInput required placeholder="Email" formControlName="email">
              <div class="text-danger" *ngIf="userForm.controls['email'].invalid && (userForm.controls['email'].touched || isFormSubmitted || userForm.controls['email'].dirty)">
                <mat-error *ngIf="userForm.controls['email'].errors?.['required']">Ce champ est obligatoire</mat-error>
                <mat-error *ngIf="userForm.controls['email'].errors?.['pattern']">Email invalide</mat-error>
              </div>

           
            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Rôle</mat-label>
              <mat-select formControlName="role" placeholder="Rôle">
                <mat-option value="ADMIN">Administrateur</mat-option>
                <mat-option value="SIMPLE_USER">Utilisateur simple</mat-option>
              </mat-select>
              <div class="text-danger" *ngIf="userForm.controls['role'].invalid && (userForm.controls['role'].touched || isFormSubmitted || userForm.controls['role'].dirty)">
                <mat-error *ngIf="userForm.controls['role'].errors?.['required']">Ce champ est obligatoire</mat-error>
               
              </div>

            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <input type="password" matInput required placeholder="Mot de passe" formControlName="password">
            </mat-form-field>
          </div>
          <div class="col-lg-6">
            <mat-form-field appearance="outline" class="w-100">
              <mat-label>Language</mat-label>
              <mat-select placeholder="Language" formControlName="language">
                <mat-option value="Français">Français</mat-option>
                <mat-option value="Anglais">Anglais</mat-option>
              </mat-select>
              <mat-error *ngIf="userForm.controls['language'].invalid && (userForm.controls['language'].touched || isFormSubmitted)">
                <ng-container *ngIf="userForm.controls['language'].errors?.['required']">
                  Ce champ est obligatoire
                </ng-container>
              </mat-error>
            </mat-form-field>
            
          </div>
          
          <div class="col-lg-6">
            <mat-checkbox formControlName="canlogin">Peut se connecter</mat-checkbox>
            <div class="text-danger" *ngIf="userForm.controls['canlogin'].invalid && (userForm.controls['canlogin'].touched || isFormSubmitted || userForm.controls['canlogin'].dirty)">
              <mat-error *ngIf="userForm.controls['canlogin'].errors?.['required']">Ce champ est obligatoire</mat-error>
             
            </div>
          </div>
        </div>
        <button mat-raised-button color="primary" class="m-l-8" (click)="addUser()">
          <span>Ajouter</span>
        </button>
        
        <button mat-stroked-button color="warn" class="m-l-8 mdc-button mdc-button--outlined mat-mdc-outlined-button mat-warn mat-mdc-button-base" (click)="closePopup()">
          <span class="mdc-button__label">Retour</span>
        </button>
        
      </form>
    </mat-dialog-content>
  </div>
</div>



    <!-- User Dialog -->
    <div *ngIf="showUserDialog" class="popup">
      <div class="popup-content">
        <mat-dialog-content class="mat-mdc-dialog-content mdc-dialog__content ng-star-inserted" style="max-width: 600px;">
          <form novalidate class="ng-pristine ng-invalid ng-touched" >
            <h2 style="text-align: center; text-decoration: underline;  ">Modifier l'utilisateur de {{selectedUser.fullName}}</h2>
            <div class="d-flex align-items-center m-b-16" *ngIf="selectedUser?.pathAvatar">
              <img width="50" class="rounded-circle" [src]="selectedUser.pathAvatar" />
              
            </div>
            
            
            <div class="row">
              <div class="col-lg-6">
                <mat-form-field appearance="outline" class="w-100">
                  <input type="text" matInput required placeholder="Nom et prénom" [(ngModel)]="selectedUser.fullName" name="fullName">
                </mat-form-field>
              </div>
              <div class="col-lg-6">
                <mat-form-field appearance="outline" class="w-100">
                  <input type="email" matInput required placeholder="Email" [(ngModel)]="selectedUser.email" name="email">
                </mat-form-field>
              </div>
              <div class="col-lg-6">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-label>Rôle</mat-label>
                  <mat-select [(ngModel)]="selectedUser.role" name="role" required>
                    <mat-option value="ADMIN">Administrateur</mat-option>
                    <mat-option value="SIMPLE_USER">Utilisateur simple</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              
             
              <div class="col-lg-6">
                <mat-form-field appearance="outline" class="w-100">
                  <mat-select required placeholder="Language" [(ngModel)]="selectedUser.language" name="language">
                    <mat-option value="Français">Français</mat-option>
                    <mat-option value="Anglais">Anglais</mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
              
              <div class="col-lg-6">
                <mat-checkbox [(ngModel)]="selectedUser.canlogin" name="canLogin">Peut se connecter</mat-checkbox>
              </div>
             
            </div>
            <button mat-raised-button color="primary" class="m-l-8" (click)="updateUser()">
              <span>Modifier</span>
            </button>
            <button mat-stroked-button color="warn" class="m-l-8 mdc-button mdc-button--outlined mat-mdc-outlined-button mat-warn mat-mdc-button-base" (click)="closeUserDialog()">
              <span class="mdc-button__label" (click)="handleBackButton()">Retour</span>
            </button>
            
            
            
          </form>
        </mat-dialog-content>
      </div>
    </div>
  <!-- user-dialog.component.html -->



  <!-- user-dialog.component.html -->

<div *ngIf="showUserDetail" class="popup">
  <div class="popup-content">
    <mat-dialog-content class="mat-mdc-dialog-content mdc-dialog__content ng-star-inserted" style="max-width: 600px;">
      <!-- Display user details -->
      <h2 style="text-align: center; text-decoration: underline;">
        Détails de l'utilisateur 
      </h2>
      
      <!-- Avatar and path input -->
      <div class="d-flex align-items-center m-b-16" *ngIf="selectedUser?.pathAvatar">
        <img width="50" class="rounded-circle" [src]="selectedUser.pathAvatar" />
        <H2>{{ selectedUser.fullName }}</H2>
      </div>
      
      <!-- User information fields -->
      <div class="row">
        <div class="col-lg-6">
          
            <mat-form-field appearance="outline" class="w-100">
              <input type="text" matInput readonly placeholder="Code" [(ngModel)]="selectedUser.code" name="code">
            </mat-form-field>
          </div>
          <div class="col-lg-6">
          <mat-form-field appearance="outline" class="w-100">
            <input type="text" matInput readonly placeholder="Nom et prénom" [(ngModel)]="selectedUser.fullName" name="fullName">
          </mat-form-field>
        </div>
        <div class="col-lg-6">
          <mat-form-field appearance="outline" class="w-100">
            <input type="email" matInput readonly placeholder="Email" [(ngModel)]="selectedUser.email" name="email">
          </mat-form-field>
        </div>
        
        <div class="col-lg-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Rôle</mat-label>
            <input matInput readonly [(ngModel)]="selectedUser.role" name="role">
          </mat-form-field>
        </div>
        <div class="col-lg-6">
          <mat-form-field appearance="outline" class="w-100">
            <mat-select required placeholder="Language" [(ngModel)]="selectedUser.language" name="language">
              <mat-option value="Français">Français</mat-option>
              <mat-option value="Anglais">Anglais</mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="col-lg-6">
          <mat-checkbox disabled [(ngModel)]="selectedUser.canlogin" name="canLogin">Peut se connecter</mat-checkbox>
        </div>
      </div>
      
      <!-- Button to close the dialog -->
      <button mat-stroked-button color="warn" class="m-l-8 mdc-button mdc-button--outlined mat-mdc-outlined-button mat-warn mat-mdc-button-base" (click)="closeUserDetail()">
        <span class="mdc-button__label" >Retour</span>
      </button>
      
    </mat-dialog-content>
  </div>
</div>


  <!-- PrimeNG Components -->
<p-toast></p-toast>
<p-confirmPopup></p-confirmPopup>